import React, { useState, useEffect, useRef } from 'react';
import { 
  Camera, ChevronRight, Utensils, Zap, Leaf, RotateCcw, Image as ImageIcon, 
  Loader2, BarChart3, ShieldCheck, CheckCircle2, AlertCircle, Plus, Minus, 
  Trash2, Users, ShoppingBasket, Scale, Droplets, Package, Lock, Apple, 
  Mail, Github, LogOut, Share2, Instagram, Twitter, MessageSquare, Check, 
  Star, Bookmark, BookOpen, Music2, Heart, Smile, Meh, Frown, User, Settings,
  Database, Info, LayoutGrid, Award, ShieldAlert, Upload, X, ShoppingCart
} from 'lucide-react';

// --- Configuration & API Helpers ---
const apiKey = ""; 
const MODEL_TEXT = "gemini-2.5-flash-preview-09-2025";
const MODEL_IMAGE = "imagen-4.0-generate-001";

const UNITS = [
  { label: 'unit√©s', value: 'unit√©s' },
  { label: 'g', value: 'g' },
  { label: 'kg', value: 'kg' },
  { label: 'ml', value: 'ml' },
  { label: 'cl', value: 'cl' }
];

// --- Avatars Ustensiles Rigolos (SVG) ---
const AVATARS = [
  { id: 'fork', name: 'Fourchette', url: `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23FFEDD5"/><path d="M45 20v30m5-30v30m5-30v30M50 50v30" stroke="%2394A3B8" stroke-width="6" stroke-linecap="round"/><circle cx="42" cy="55" r="3" fill="%231E293B"/><circle cx="58" cy="55" r="3" fill="%231E293B"/><path d="M45 65q5 5 10 0" stroke="%231E293B" stroke-width="2" fill="none" stroke-linecap="round"/></svg>` },
  { id: 'whisk', name: 'Fouet', url: `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23F0FDF4"/><path d="M50 20c-15 0-15 40 0 40s15-40 0-40zM50 20c-8 0-8 40 0 40s8-40 0-40zM50 60v20" stroke="%2394A3B8" stroke-width="4" fill="none"/><circle cx="42" cy="35" r="3" fill="%231E293B"/><circle cx="58" cy="35" r="3" fill="%231E293B"/><path d="M46 45h8" stroke="%231E293B" stroke-width="2" stroke-linecap="round"/></svg>` },
  { id: 'ladle', name: 'Louche', url: `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23EFF6FF"/><path d="M30 40a20 20 0 0 0 40 0h-40zM50 40V15" stroke="%2394A3B8" stroke-width="6" fill="%23CBD5E1"/><circle cx="40" cy="48" r="3" fill="%231E293B"/><circle cx="60" cy="48" r="3" fill="%231E293B"/><path d="M45 55q5 4 10 0" stroke="%231E293B" stroke-width="2" fill="none" stroke-linecap="round"/></svg>` },
  { id: 'spatula', name: 'Spatule', url: `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23FEF2F2"/><path d="M35 20h30v30H35zM50 50v30" stroke="%2394A3B8" stroke-width="6" fill="%23CBD5E1"/><circle cx="40" cy="30" r="3" fill="%231E293B"/><circle cx="60" cy="30" r="3" fill="%231E293B"/><path d="M40 40h20" stroke="%231E293B" stroke-width="3" stroke-linecap="round"/></svg>` }
];

const COMMON_ALLERGIES = ["Gluten", "Lactose", "Arachides", "≈íufs", "Soja", "Noix", "Fruits de mer"];

// --- API Functions ---
const callGeminiVision = async (imagesBase64) => {
  const prompt = `Identifie pr√©cis√©ment les ingr√©dients alimentaires visibles. R√©ponds UNIQUEMENT au format JSON : {"ingredients": [{"name": "Nom", "brand": "Marque", "amount": 1, "unit": "unit√©s"}]}`;
  const imageParts = imagesBase64.map(b64 => ({ inlineData: { mimeType: "image/png", data: b64.split(',')[1] } }));
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }, ...imageParts] }], generationConfig: { responseMimeType: "application/json" } })
    });
    const result = await response.json();
    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!text) throw new Error("IA muette.");
    return JSON.parse(text).ingredients || [];
  } catch (e) { throw e; }
};

const generateRecipesFromAI = async (ingredients, peopleCount) => {
  const list = (ingredients || []).map(i => `${i.amount}${i.unit} de ${i.name} ${i.brand ? `(${i.brand})` : ''}`).join(', ');
  const prompt = `CONSIGNE : Propose 3 recettes pour ${peopleCount} pers. avec UNIQUEMENT: [${list}].
  CAS SP√âCIAL : Si un seul ingr√©dient minimaliste (ex: 1 citron seul), propose une pr√©paration simple ET utilise un ton humoristique sur le frigo vide.
  R√©ponds en JSON strict : [{"id": 1, "title": "...", "description": "...", "time": "...", "type": "...", "steps": ["..."]}]`;
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
    });
    const result = await response.json();
    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
    return JSON.parse(text) || [];
  } catch (e) { throw e; }
};

const generateDishImage = async (recipeTitle) => {
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_IMAGE}:predict?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ instances: { prompt: `Food photography, ${recipeTitle}, simple minimal style` }, parameters: { sampleCount: 1 } })
    });
    const result = await response.json();
    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
  } catch (e) { return `https://images.unsplash.com/photo-1490645935967-10de6ba17061?w=800&q=80`; }
};

// --- Bilan Final UI ---

const BilanFinal = ({ photo, title, onRestart, onPhotoCapture }) => {
  const [rating, setRating] = useState(0);
  const [copied, setCopied] = useState(false);

  const copyPost = () => {
    const text = `Je cuisine avec #SnapChef ! üç≥‚ú® #AntiGaspi`;
    const el = document.createElement("textarea"); el.value = text;
    document.body.appendChild(el); el.select(); document.execCommand('copy');
    document.body.removeChild(el); setCopied(true); setTimeout(() => setCopied(false), 2000);
  };

  const ratings = [
    {v:1, i:Frown, c:"text-red-400", bg:"bg-red-50", l:"Bof"}, 
    {v:2, i:Meh, c:"text-orange-400", bg:"bg-orange-50", l:"Ok"}, 
    {v:3, i:Smile, c:"text-green-500", bg:"bg-green-50", l:"Miam"}
  ];

  return (
    <div className="p-8 space-y-8 animate-in zoom-in duration-700 flex flex-col items-center pb-32 h-full overflow-y-auto">
      <div className="text-center space-y-6 w-full">
        <h2 className="text-4xl font-black tracking-tight leading-tight text-slate-900">Alors, c'√©tait <br/><span className="text-orange-500">comment ?</span></h2>
        <div className="flex gap-4 justify-center">
          {ratings.map(r => (
            <button key={`csat-${r.v}`} onClick={() => setRating(r.v)} className={`flex-1 flex flex-col items-center gap-2 p-4 rounded-3xl transition-all ${rating === r.v ? 'scale-105 shadow-xl ring-2 ring-orange-500 ring-offset-2' : 'opacity-60'} ${r.bg}`}>
              <r.i size={36} className={r.c} />
              <span className={`text-[10px] font-black uppercase tracking-tighter ${r.c}`}>{r.l}</span>
            </button>
          ))}
        </div>
      </div>

      <div className="w-full bg-white p-8 rounded-[3.5rem] shadow-sm border border-slate-100 space-y-8">
        <div className="text-center space-y-5">
           <p className="text-[10px] font-black uppercase text-slate-400 tracking-[0.25em]">Partager mon assiette</p>
           <div className="relative group">
             {photo ? (
               <div className="aspect-square rounded-[3rem] overflow-hidden border-8 border-slate-50 shadow-inner rotate-1 transition-transform">
                 <img src={photo} className="w-full h-full object-cover" alt="Mon plat" />
                 <button onClick={() => onPhotoCapture(null)} className="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity"><X size={16}/></button>
               </div>
             ) : (
               <label className="aspect-square rounded-[3rem] border-4 border-dashed border-slate-100 bg-slate-50 flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:bg-orange-50 active:scale-95 transition-all">
                 <Camera size={48} strokeWidth={1.5} />
                 <span className="text-xs font-black uppercase mt-3 tracking-widest text-center px-4 leading-tight">Prendre la photo</span>
                 <input type="file" accept="image/*" className="hidden" onChange={(e) => {
                   const f = e.target.files[0];
                   if(f) { const r = new FileReader(); r.onloadend = () => onPhotoCapture(r.result); r.readAsDataURL(f); }
                 }} />
               </label>
             )}
           </div>
           <div className="grid grid-cols-4 gap-4 pt-4">
              <button onClick={copyPost} className="h-14 w-14 bg-slate-50 rounded-2xl flex items-center justify-center text-pink-500 active:scale-90 transition-all"><Instagram size={28}/></button>
              <button onClick={copyPost} className="h-14 w-14 bg-slate-50 rounded-2xl flex items-center justify-center text-blue-400 active:scale-90 transition-all"><Twitter size={28}/></button>
              <button onClick={copyPost} className="h-14 w-14 bg-slate-900 rounded-2xl flex items-center justify-center text-white active:scale-90 transition-all"><Music2 size={28}/></button>
              <button onClick={copyPost} className="h-14 w-14 bg-orange-50 rounded-2xl flex items-center justify-center text-orange-500 active:scale-90 transition-all"><Share2 size={28}/></button>
           </div>
        </div>
        <button onClick={copyPost} className={`w-full py-5 rounded-[2rem] font-black text-lg flex items-center justify-center gap-3 transition-all ${copied ? 'bg-green-500 text-white shadow-green-100 shadow-xl' : 'bg-slate-900 text-white shadow-2xl shadow-slate-200'}`}>
          {copied ? <Check size={24}/> : <ImageIcon size={24}/>}
          {copied ? "Message Copi√© !" : "Partager sur #SnapChef"}
        </button>
      </div>
      <button onClick={onRestart} className="text-slate-400 font-bold text-sm uppercase tracking-widest hover:text-orange-500 transition-colors pt-4">Nouveau Snap</button>
    </div>
  );
};

// --- App Component ---

export default function App() {
  const [step, setStep] = useState('splash');
  const [userProfile, setUserProfile] = useState({ 
    householdType: 'Solo', diet: 'Tous', gdpr: true, 
    avatar: AVATARS[0].url, level: 'Bronze', allergies: [] 
  });
  const [photos, setPhotos] = useState([]);
  const [ingredients, setIngredients] = useState([]);
  const [peopleCount, setPeopleCount] = useState(1);
  const [recipes, setRecipes] = useState([]);
  const [pinnedRecipes, setPinnedRecipes] = useState([]);
  const [selectedRecipe, setSelectedRecipe] = useState(null);
  const [platePhoto, setPlatePhoto] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [loadingText, setLoadingText] = useState("");
  const [allergyAlert, setAllergyAlert] = useState([]);
  const [customAllergy, setCustomAllergy] = useState("");

  // Splash Screen Logic (Version silencieuse)
  useEffect(() => {
    if (step === 'splash') {
      const timer = setTimeout(() => setStep('auth'), 4200);
      return () => clearTimeout(timer);
    }
  }, [step]);

  useEffect(() => {
    if (userProfile.householdType === 'Solo') setPeopleCount(1);
    else if (userProfile.householdType === 'Duo') setPeopleCount(2);
    else setPeopleCount(4);
  }, [userProfile.householdType]);

  const handleCapture = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => { setPhotos(p => [...p, reader.result]); setStep('review'); };
      reader.readAsDataURL(file);
    }
  };

  const handleAvatarUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setUserProfile(prev => ({...prev, avatar: reader.result}));
      reader.readAsDataURL(file);
    }
  };

  const processVision = async () => {
    setIsLoading(true); setStep('loading');
    try {
      setLoadingText("Analyse Vision IA...");
      const detected = await callGeminiVision(photos);
      const found = detected.filter(ing => 
        userProfile.allergies.some(all => ing.name?.toLowerCase().includes(all.toLowerCase()))
      );
      if (found.length > 0) {
        setAllergyAlert(found); setStep('allergy_warning');
        setIsLoading(false); 
        return;
      }
      setIngredients(detected); setStep('refine');
    } catch (e) { setStep('landing'); } finally { setIsLoading(false); }
  };

  const processRecipes = async () => {
    setIsLoading(true); setStep('loading');
    try {
      setLoadingText("V√©rification du garde-manger...");
      const gen = await generateRecipesFromAI(ingredients, peopleCount);
      const withImgs = await Promise.all(gen.map(async r => ({ ...r, imageUrl: await generateDishImage(r.title) })));
      setRecipes(withImgs); setStep('results');
    } catch (e) { setStep('landing'); } finally { setIsLoading(false); }
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans max-w-md mx-auto relative flex flex-col shadow-2xl overflow-hidden">
      
      {/* 1. SPLASH SCREEN CIN√âMATIQUE (SILENCIEUX) */}
      {step === 'splash' && (
        <div className="absolute inset-0 z-[110] bg-slate-900 flex flex-col items-center justify-center p-8 text-center">
          <div className="absolute inset-0 opacity-20 pointer-events-none">
             <div className="absolute top-1/4 left-1/4 w-80 h-80 bg-orange-500 rounded-full blur-[100px] animate-pulse"></div>
             <div className="absolute bottom-1/4 right-1/4 w-80 h-80 bg-blue-600 rounded-full blur-[100px] animate-pulse delay-1000"></div>
          </div>

          <div className="relative flex flex-col items-center animate-in fade-in zoom-in duration-1000">
            <div className="w-36 h-36 bg-orange-500 rounded-[4rem] flex items-center justify-center text-white shadow-[0_25px_60px_rgba(249,115,22,0.4)] rotate-12 transition-all hover:rotate-0 mb-12 relative overflow-hidden group">
              <Utensils size={64} strokeWidth={2.5} />
              <div className="absolute inset-0 bg-white/10 animate-[pulse_2s_infinite]"></div>
            </div>
            <div className="space-y-4">
               <h1 className="text-6xl font-black text-white tracking-tighter animate-in slide-in-from-bottom-12 duration-1000 delay-500">SnapChef</h1>
               <div className="flex items-center justify-center gap-3 animate-in fade-in duration-1000 delay-1000 opacity-60">
                  <div className="h-px w-8 bg-orange-500"></div>
                  <p className="text-orange-500 font-black uppercase tracking-[0.6em] text-[8px]">L'IA de votre cuisine</p>
                  <div className="h-px w-8 bg-orange-500"></div>
               </div>
            </div>
          </div>

          <div className="absolute bottom-20 w-full px-20 space-y-4">
             <div className="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                <div className="h-full bg-gradient-to-r from-orange-600 to-orange-400 animate-[loading_4.2s_linear]"></div>
             </div>
             <p className="text-slate-500 text-[10px] font-black uppercase tracking-widest animate-pulse">Initialisation IA...</p>
          </div>
          <style>{` @keyframes loading { 0% { width: 0%; } 100% { width: 100%; } } `}</style>
        </div>
      )}

      {/* 2. AUTH */}
      {step === 'auth' && (
        <div className="absolute inset-0 z-[90] bg-white flex flex-col p-10 items-center justify-center text-center space-y-12 animate-in fade-in duration-700">
           <div className="w-20 h-20 bg-orange-500 rounded-[2rem] flex items-center justify-center text-white shadow-xl shadow-orange-100"><Utensils size={36} /></div>
           <div className="space-y-4">
              <h2 className="text-3xl font-black tracking-tight leading-[1.1]">Cuisinez avec <br/><span className="text-orange-500">ce qu'il vous reste.</span></h2>
              <p className="text-slate-400">Rapprochez-vous du z√©ro d√©chet.</p>
           </div>
           <div className="w-full space-y-4">
              <button onClick={() => setStep('profile_setup')} className="w-full py-5 bg-white border-2 border-slate-100 rounded-[2rem] font-black flex items-center justify-center gap-4 text-slate-700 active:scale-95 shadow-sm transition-all">
                 <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.66l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                 Google Login
              </button>
              <button onClick={() => setStep('profile_setup')} className="w-full py-5 bg-slate-900 text-white rounded-[2rem] font-black active:scale-95 transition-all">S'inscrire</button>
           </div>
        </div>
      )}

      {/* 3. PROFILE SETUP */}
      {step === 'profile_setup' && (
        <div className="absolute inset-0 z-[85] bg-white p-8 flex flex-col animate-in slide-in-from-right duration-500 overflow-y-auto pb-10">
           <div className="flex-1 space-y-10 pt-10">
              <div className="text-center space-y-6">
                 <h2 className="text-4xl font-black tracking-tight italic text-slate-900">Profil</h2>
                 <div className="flex flex-col items-center gap-6">
                    <div className="relative">
                       <div className={`w-32 h-32 rounded-[3.5rem] overflow-hidden border-4 border-white shadow-2xl bg-gradient-to-br p-1 flex items-center justify-center transition-transform hover:scale-105 ${userProfile.level === 'Or' ? 'from-yellow-400 to-orange-500' : 'from-slate-400 to-slate-600'}`}>
                          <img src={userProfile.avatar} className="w-full h-full object-cover rounded-[3.2rem]" alt="Me" />
                       </div>
                       <label className="absolute -bottom-2 -right-2 h-10 w-10 bg-slate-900 text-white rounded-2xl flex items-center justify-center border-4 border-white shadow-lg cursor-pointer hover:bg-black active:scale-90 transition-all"><Upload size={18} /><input type="file" accept="image/*" className="hidden" onChange={handleAvatarUpload} /></label>
                    </div>
                    <div className="grid grid-cols-4 gap-4">
                       {AVATARS.map((av) => (
                          <button key={`av-sel-${av.id}`} onClick={() => setUserProfile(p => ({...p, avatar: av.url}))} className={`w-14 h-14 rounded-2xl border-2 p-1 transition-all ${userProfile.avatar === av.url ? 'border-orange-500 bg-orange-50 scale-105' : 'border-slate-100'}`}><img src={av.url} alt={av.name} /></button>
                       ))}
                    </div>
                    <div className="flex items-center gap-2 px-6 py-2 bg-orange-50 rounded-full border border-orange-100"><Award size={18} className="text-orange-500" /><span className="text-[11px] font-black uppercase tracking-widest text-orange-600">Rang {userProfile.level}</span></div>
                 </div>
              </div>
              <div className="space-y-10 pb-10 text-left">
                 <div className="space-y-4">
                    <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Taille du foyer</label>
                    <div className="grid grid-cols-3 gap-3">
                       {['Solo', 'Duo', 'Famille'].map(t => (
                          <button key={`house-${t}`} onClick={() => setUserProfile(p => ({...p, householdType: t}))} className={`py-4 rounded-[1.8rem] font-black text-xs border-2 transition-all ${userProfile.householdType === t ? 'border-orange-500 bg-orange-50 text-orange-600' : 'border-slate-100'}`}>{t}</button>
                       ))}
                    </div>
                 </div>
                 <div className="space-y-5">
                    <label className="text-[10px] font-black uppercase text-slate-400 tracking-widest">Allergies</label>
                    <div className="flex flex-wrap gap-2">
                       {COMMON_ALLERGIES.map(all => (
                          <button key={`all-${all}`} onClick={() => setUserProfile(p => ({...p, allergies: p.allergies.includes(all) ? p.allergies.filter(a => a !== all) : [...p.allergies, all]}))} className={`px-4 py-2.5 rounded-xl text-xs font-bold border-2 transition-all ${userProfile.allergies.includes(all) ? 'bg-red-50 border-red-500 text-red-600' : 'bg-white border-slate-100'}`}>{all}</button>
                       ))}
                    </div>
                    <div className="flex gap-3">
                       <input type="text" placeholder="Ajouter allergie..." value={customAllergy} onChange={(e) => setCustomAllergy(e.target.value)} className="flex-1 bg-slate-50 border-none rounded-2xl text-sm px-5 h-12 focus:ring-orange-500" onKeyDown={(e) => { if(e.key === 'Enter' && customAllergy) { setUserProfile(p => ({...p, allergies: [...p.allergies, customAllergy]})); setCustomAllergy(""); } }} />
                       <button onClick={() => { if(customAllergy) { setUserProfile(p => ({...p, allergies: [...p.allergies, customAllergy]})); setCustomAllergy(""); } }} className="h-12 w-12 bg-slate-900 text-white rounded-2xl flex items-center justify-center"><Plus size={24}/></button>
                    </div>
                 </div>
              </div>
           </div>
           <button onClick={() => setStep('landing')} className="w-full mt-4 py-6 bg-orange-500 text-white rounded-[2.5rem] font-black text-xl shadow-2xl active:scale-95 transition-all">Cuisiner !</button>
        </div>
      )}

      {/* HEADER */}
      {step !== 'splash' && step !== 'auth' && step !== 'profile_setup' && (
        <header className="p-6 flex items-center justify-between bg-white/90 backdrop-blur-md sticky top-0 z-50 border-b border-slate-100">
          <div className="flex items-center gap-3 cursor-pointer" onClick={() => { setStep('landing'); setPhotos([]); setAllergyAlert([]); }}>
            <div className="w-10 h-10 bg-slate-900 rounded-2xl flex items-center justify-center text-white shadow-md transition-transform active:scale-90"><Lock size={18} className="text-orange-500" /></div>
            <span className="text-xl font-black tracking-tight text-slate-800">SnapChef</span>
          </div>
          <div className="flex items-center gap-3">
             <button onClick={() => setStep('profile_setup')} className="w-11 h-11 rounded-[1.25rem] overflow-hidden border-2 border-white shadow-xl bg-orange-50 p-1 active:scale-90 transition-all"><img src={userProfile.avatar} alt="Avatar" className="w-full h-full object-cover" /></button>
             <button onClick={() => setStep('book')} className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 relative transition-transform active:scale-90 shadow-sm">
                <BookOpen size={20} />
                {pinnedRecipes.length > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-orange-500 text-white text-[8px] font-black flex items-center justify-center rounded-full border-2 border-white">{pinnedRecipes.length}</span>}
             </button>
             <button onClick={() => setStep('auth')} className="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 hover:text-red-500 transition-colors shadow-sm"><LogOut size={18} /></button>
          </div>
        </header>
      )}

      <main className="flex-1 overflow-y-auto">
        {step === 'landing' && (
          <div className="p-8 flex flex-col items-center text-center space-y-12 animate-in fade-in duration-700">
            <h1 className="text-5xl font-black leading-[1.05] tracking-tight text-slate-900 italic">Le go√ªt de <br/><span className="text-orange-500 text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-orange-300 italic">l'essentiel.</span></h1>
            <label className="block w-full cursor-pointer group">
              <div className="bg-slate-900 text-white p-16 rounded-[4.5rem] shadow-2xl flex flex-col items-center gap-6 group-hover:bg-black transition-all transform active:scale-95 shadow-slate-200">
                <Camera size={72} className="text-orange-500" strokeWidth={2.5} />
                <span className="text-3xl font-black uppercase tracking-tighter">Scanner</span>
              </div>
              <input type="file" accept="image/*" className="hidden" onChange={handleCapture} />
            </label>
            <div className="p-6 bg-white rounded-[2.5rem] border border-slate-100 shadow-sm flex items-center gap-4 text-left">
               <ShieldCheck className="text-green-600 flex-none" size={28} />
               <p className="text-xs font-bold text-slate-500 leading-relaxed">Profil <span className="text-orange-500 font-black">{userProfile.householdType}</span> : Menus pour <span className="text-slate-900 underline">{peopleCount} pers.</span></p>
            </div>
          </div>
        )}

        {step === 'review' && (
          <div className="p-8 space-y-8 animate-in slide-in-from-bottom-5 duration-500">
            <h2 className="text-3xl font-black tracking-tight text-slate-900">Captures ({photos.length})</h2>
            <div className="grid grid-cols-2 gap-4">
              {photos.map((p, i) => (
                <div key={`capture-view-${i}`} className="aspect-square rounded-[2.5rem] overflow-hidden border-4 border-white shadow-xl relative animate-in zoom-in">
                  <img src={p} className="w-full h-full object-cover" alt="" />
                  <button onClick={() => setPhotos(photos.filter((_, idx) => idx !== i))} className="absolute top-3 right-3 bg-red-500 text-white p-2 rounded-full shadow-lg"><Trash2 size={16}/></button>
                </div>
              ))}
              <label className="aspect-square rounded-[2.5rem] border-4 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-300 cursor-pointer active:scale-95 transition-all hover:bg-white">
                <Plus size={40} /><input type="file" accept="image/*" className="hidden" onChange={handleCapture} />
              </label>
            </div>
            <button onClick={processVision} className="w-full h-24 bg-slate-900 text-white rounded-[2.5rem] font-black text-2xl flex items-center justify-center gap-3 shadow-2xl active:scale-95 transition-all">Cuisiner ! <ChevronRight className="text-orange-500" strokeWidth={3} /></button>
          </div>
        )}

        {step === 'loading' && (
          <div className="h-full flex flex-col items-center justify-center p-8 space-y-10 animate-in fade-in duration-500">
            <Loader2 className="animate-spin text-orange-500" size={84} />
            <div className="text-center space-y-3">
              <h2 className="text-3xl font-black text-slate-900">{loadingText}</h2>
              <p className="text-slate-400 italic font-medium">Gemini Pro Vision calibre vos restes...</p>
            </div>
          </div>
        )}

        {step === 'allergy_warning' && (
          <div className="p-10 flex flex-col items-center justify-center h-[80vh] text-center space-y-10 animate-in zoom-in duration-500">
             <div className="w-32 h-32 bg-red-50 text-red-500 rounded-[3.5rem] flex items-center justify-center shadow-xl border-4 border-red-100 animate-bounce"><ShieldAlert size={64} strokeWidth={2.5} /></div>
             <div className="space-y-4">
                <h2 className="text-5xl font-black text-red-600 italic tracking-tighter uppercase">Attention !</h2>
                <p className="text-slate-500 font-medium leading-relaxed">Allerg√®nes d√©tect√©s dans vos captures :</p>
                <div className="flex flex-wrap gap-2 justify-center">
                   {allergyAlert.map((a, i) => <span key={`all-warn-${i}`} className="px-6 py-3 bg-red-600 text-white rounded-[1.5rem] font-black text-sm shadow-xl">{a.name}</span>)}
                </div>
             </div>
             <div className="w-full space-y-4 pt-10">
                <button onClick={() => setStep('refine')} className="w-full py-5 bg-slate-100 text-slate-600 rounded-[2.2rem] font-black active:scale-95 transition-all underline">Ignorer (√† mes risques)</button>
                <button onClick={() => { setPhotos([]); setStep('landing'); }} className="w-full py-6 bg-red-600 text-white rounded-[2.2rem] font-black text-xl shadow-2xl active:scale-95 transition-all">Effacer les captures</button>
             </div>
          </div>
        )}

        {step === 'refine' && (
          <div className="p-8 space-y-10 pb-44 animate-in fade-in duration-500">
            <h2 className="text-4xl font-black tracking-tight text-slate-900 italic">Stocks R√©els</h2>
            <div className="bg-white p-8 rounded-[3.5rem] shadow-sm border border-slate-100 flex items-center justify-between font-bold">
              <div className="flex items-center gap-4"><Users className="text-orange-500" /><span>Convives</span></div>
              <div className="flex items-center gap-6">
                <button onClick={() => setPeopleCount(Math.max(1, peopleCount - 1))} className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center active:scale-90 transition-all shadow-sm"><Minus size={22} /></button>
                <span className="text-3xl font-black w-8 text-center">{peopleCount}</span>
                <button onClick={() => setPeopleCount(peopleCount + 1)} className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center active:scale-90 transition-all shadow-sm"><Plus size={22} /></button>
              </div>
            </div>
            <div className="space-y-6 text-left">
              {(ingredients || []).map((ing, i) => (
                <div key={`ing-list-item-${i}`} className="bg-white p-8 rounded-[4rem] shadow-sm border border-slate-100 flex flex-col gap-6">
                   <div className="flex justify-between items-start">
                      <div className="flex-1 pr-2">
                        <input type="text" value={ing.name} onChange={(e) => { const n = [...ingredients]; n[i].name = e.target.value; setIngredients(n); }} className="w-full font-black text-2xl bg-transparent border-none p-0 focus:ring-0 leading-tight" />
                        {ing.brand && <span className="text-[11px] font-black uppercase text-orange-400 bg-orange-50 px-3 py-1 rounded-lg mt-2 inline-block tracking-widest">{ing.brand}</span>}
                      </div>
                      <button onClick={() => setIngredients(ingredients.filter((_, idx) => idx !== i))} className="text-slate-200 hover:text-red-500 transition-colors p-2"><Trash2 size={28}/></button>
                   </div>
                   <div className="space-y-5">
                     <div className="flex bg-slate-100 p-1.5 rounded-2xl gap-1.5 border border-slate-200/50">
                        {UNITS.map((u) => (
                          <button key={`unit-sel-${u.value}`} onClick={() => { const n = [...ingredients]; n[i].unit = u.value; setIngredients(n); }} className={`flex-1 py-2.5 px-3 rounded-xl text-[11px] font-black uppercase tracking-widest transition-all ${ing.unit === u.value ? 'bg-white text-orange-500 shadow-sm ring-1 ring-slate-100' : 'text-slate-400'}`}>{u.label}</button>
                        ))}
                     </div>
                     <div className="flex items-center bg-slate-50 rounded-3xl p-2 border border-slate-100 w-full shadow-inner">
                        <button onClick={() => { const n = [...ingredients]; n[i].amount = Math.max(0, n[i].amount - ((ing.unit === 'kg' || ing.unit === 'unit√©s') ? 0.5 : 50)); setIngredients(n); }} className="w-14 h-14 flex items-center justify-center text-slate-400 hover:text-orange-500 active:scale-90 transition-all"><Minus size={24} /></button>
                        <input type="number" value={ing.amount} onChange={(e) => { const n = [...ingredients]; n[i].amount = parseFloat(e.target.value) || 0; setIngredients(n); }} className="flex-1 text-center bg-transparent border-none text-3xl font-black text-slate-900 focus:ring-0" />
                        <button onClick={() => { const n = [...ingredients]; n[i].amount = n[i].amount + ((ing.unit === 'kg' || ing.unit === 'unit√©s') ? 0.5 : 50); setIngredients(n); }} className="w-14 h-14 flex items-center justify-center text-slate-400 hover:text-orange-500 active:scale-90 transition-all"><Plus size={24} /></button>
                     </div>
                   </div>
                </div>
              ))}
            </div>
            <button onClick={processRecipes} className="fixed bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-[360px] h-24 bg-slate-900 text-white rounded-full font-black text-2xl shadow-[0_30px_60px_-15px_rgba(0,0,0,0.5)] z-50 flex items-center justify-center gap-3 active:scale-95 transition-all">G√©n√©rer mon menu <ChevronRight className="text-orange-500" strokeWidth={3} /></button>
          </div>
        )}

        {step === 'results' && (
          <div className="p-8 space-y-10 animate-in fade-in duration-500 pb-32">
            <h2 className="text-4xl font-black tracking-tight leading-none text-slate-900 italic">Suggestions</h2>
            <div className="space-y-8">
              {recipes.map((recipe, idx) => (
                <div key={`recipe-res-${recipe.id}-${idx}`} className="bg-white rounded-[4.5rem] overflow-hidden shadow-2xl border border-slate-50 relative group cursor-pointer" onClick={() => { setSelectedRecipe(recipe); setStep('recipe'); }}>
                  <div className="h-72 relative overflow-hidden">
                    <img src={recipe.imageUrl} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-1000" alt="" />
                    <div className="absolute top-6 left-6 px-6 py-2.5 rounded-full text-[10px] font-black uppercase text-white bg-slate-900/80 backdrop-blur-md shadow-lg border border-white/10">{recipe.type}</div>
                    <button onClick={(e) => { e.stopPropagation(); setPinnedRecipes(prev => {
                      const exists = prev.find(p => p.id === recipe.id);
                      if (exists) return prev.filter(p => p.id !== recipe.id);
                      return [...prev, {id: recipe.id}];
                    }); }} className="absolute top-6 right-6 h-12 w-12 bg-white rounded-full flex items-center justify-center text-orange-500 active:scale-90 transition-all shadow-2xl">
                      <Bookmark size={28} fill={pinnedRecipes.find(p => p.id === recipe.id) ? "currentColor" : "none"} />
                    </button>
                  </div>
                  <div className="p-10 space-y-4 text-left">
                    <div className="flex justify-between items-center"><h3 className="text-2xl font-black leading-tight flex-1 pr-4">{recipe.title}</h3><span className="text-orange-500 font-black text-sm">{recipe.time}</span></div>
                    <p className="text-slate-400 text-base italic font-medium leading-relaxed">"{recipe.description}"</p>
                  </div>
                </div>
              ))}
            </div>
            {ingredients.length === 1 && (
               <div className="bg-orange-50 p-10 rounded-[4rem] border-2 border-orange-200 flex flex-col items-center gap-5 text-center animate-bounce mt-10 shadow-xl shadow-orange-100">
                  <ShoppingCart size={48} className="text-orange-500" />
                  <p className="font-black text-orange-700 uppercase tracking-tighter text-xl leading-tight">C'est le d√©sert ici ! <br/>Ton frigo se sent seul. üõí</p>
               </div>
            )}
          </div>
        )}

        {step === 'book' && (
           <div className="p-10 space-y-10 animate-in slide-in-from-left duration-700 pb-32 h-full overflow-y-auto">
              <h2 className="text-5xl font-black tracking-tighter leading-none text-slate-900 italic uppercase">Mon Livre <br/><span className="text-orange-500 italic">Anti-Gaspi</span></h2>
              {pinnedRecipes.length === 0 ? (
                <div className="p-20 text-center text-slate-300 font-black bg-white rounded-[5rem] shadow-sm border-4 border-dashed border-slate-50 uppercase tracking-[0.3em] text-xs">Aucune recette <br/>√©pingl√©e.</div>
              ) : (
                <div className="space-y-6">
                   {pinnedRecipes.map((pinned, idx) => {
                     const r = recipes.find(rec => rec.id === pinned.id) || { title: "Recette", time: "15 min", imageUrl: "" };
                     return (
                      <div key={`pinned-book-${idx}`} className="bg-white p-5 rounded-[3.5rem] flex items-center gap-5 shadow-sm active:scale-95 transition-all" onClick={() => { setSelectedRecipe(r); setStep('recipe'); }}>
                        <div className="w-24 h-24 rounded-[2rem] overflow-hidden flex-none shadow-2xl border-4 border-white"><img src={r.imageUrl} className="w-full h-full object-cover" alt="" /></div>
                        <div className="flex-1 text-left"><h4 className="font-black text-xl leading-tight text-slate-900">{r.title}</h4><p className="text-sm text-orange-500 font-bold mt-1 uppercase tracking-widest">{r.time}</p></div>
                        <Bookmark fill="currentColor" className="text-orange-500 mr-2 flex-none" size={28} />
                      </div>
                     );
                   })}
                </div>
              )}
           </div>
        )}

        {step === 'recipe' && selectedRecipe && (
          <div className="animate-in slide-in-from-right-10 duration-500 pb-40">
             <div className="h-[500px] relative">
                <img src={selectedRecipe.imageUrl} className="w-full h-full object-cover" alt="" />
                <button className="absolute top-10 left-8 h-16 w-16 bg-white rounded-full shadow-2xl flex items-center justify-center text-slate-900 active:scale-90 transition-all" onClick={() => setStep('results')}><ChevronRight className="rotate-180" size={32} /></button>
             </div>
             <div className="p-12 bg-white rounded-t-[6rem] -mt-24 relative z-10 space-y-12 min-h-[70vh] shadow-[-20px_-20px_60px_rgba(0,0,0,0.1)]">
                <div className="space-y-5 text-center">
                  <h2 className="text-5xl font-black leading-tight tracking-tight text-slate-900 italic uppercase">{selectedRecipe.title}</h2>
                  <div className="flex gap-4 justify-center">
                    <div className="bg-slate-900 text-white px-6 py-3 rounded-2xl font-black text-sm flex items-center gap-2 shadow-2xl"><CheckCircle2 size={18} className="text-orange-500" /> 100% R√©el</div>
                    <div className="bg-blue-50 text-blue-600 px-6 py-3 rounded-2xl font-black text-sm shadow-sm">{peopleCount} Pers.</div>
                  </div>
                </div>
                <div className="space-y-12 text-left">
                  <h3 className="text-3xl font-black flex items-center gap-5 text-slate-900 italic"><Utensils size={36} className="text-orange-500" /> Pr√©paration</h3>
                  <div className="space-y-12">
                    {selectedRecipe.steps.map((s, i) => (
                      <div key={`step-guide-${i}`} className="flex gap-8 group">
                        <div className="flex-none w-14 h-14 rounded-[1.8rem] bg-slate-50 text-slate-900 flex items-center justify-center font-black text-2xl group-hover:bg-orange-500 group-hover:text-white transition-all duration-500 shadow-sm">{i+1}</div>
                        <p className="text-slate-600 text-2xl pt-2 leading-tight">{s}</p>
                      </div>
                    ))}
                  </div>
                </div>
                <button 
                  onClick={() => setStep('feedback_share')}
                  className="w-full py-8 bg-orange-500 text-white rounded-[4rem] shadow-2xl font-black text-3xl italic tracking-tighter uppercase active:scale-95 transition-all transform hover:shadow-orange-200"
                >
                   J'ai termin√© !
                </button>
             </div>
          </div>
        )}

        {step === 'feedback_share' && (
           <BilanFinal photo={platePhoto} title={selectedRecipe?.title} recipe={selectedRecipe} onRestart={() => {setPhotos([]); setIngredients([]); setPlatePhoto(null); setStep('landing');}} onPhotoCapture={(img) => setPlatePhoto(img)} onSaveToBook={() => {}} />
        )}
      </main>

      {/* FOOTER NAV */}
      {(step === 'landing' || step === 'results' || step === 'book') && (
        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 w-[85%] bg-slate-900/95 backdrop-blur-3xl border border-white/10 shadow-[0_30px_60px_-10px_rgba(0,0,0,0.6)] rounded-full px-12 py-7 flex items-center justify-between z-[80] animate-in slide-in-from-bottom-24 duration-1000">
           <button onClick={() => setStep('landing')} className={`transition-all duration-500 ${step === 'landing' ? 'text-orange-500 scale-150' : 'text-white/30 hover:text-white'}`}><Utensils size={28} strokeWidth={2.5} /></button>
           <label className="h-20 w-20 bg-orange-500 rounded-full flex items-center justify-center text-white shadow-2xl shadow-orange-500/40 -mt-16 border-[10px] border-slate-900 cursor-pointer active:scale-90 transition-all hover:bg-orange-400">
             <Camera size={34} strokeWidth={3} /><input type="file" accept="image/*" className="hidden" onChange={handleCapture} />
           </label>
           <button onClick={() => setStep('book')} className={`transition-all duration-500 ${step === 'book' ? 'text-orange-500 scale-150' : 'text-white/30 hover:text-white'}`}><BookOpen size={28} strokeWidth={2.5} /></button>
        </div>
      )}
    </div>
  );
}
